# Guix System Configuration for ser8 (orka user)

This repository contains my Guix System and Guix Home configurations, tailored for the `ser8` machine and `orka` user. It features LUKS encryption, Btrfs with subvolumes, KDE Plasma desktop, PipeWire audio, and Steam controller support.

## Overview

*   **System Name:** `ser8`
*   **User Name:** `orka`
*   **Disk Setup:** LUKS2 encrypted root partition with Btrfs filesystem and multiple subvolumes (`@`, `@home`, `@boot`, `@var`, etc.).
*   **Desktop Environment:** KDE Plasma
*   **Audio:** Explicitly configured PipeWire.
*   **Korean IME:** Fcitx5 with Hangul support.
*   **Default Shell (User):** Zsh
*   **Editors:** Helix and Neovim.
*   **Fonts:** JetBrains Mono Nerd Font, D2Coding Nerd Font.
*   **Gaming:** Steam package with integrated Steam controller udev rules.
*   **Finance:** `hledger` and `emacs-ledger-mode` included.
*   **Dotfiles:** Managed recursively for `orka` user.

## Structure

*   `Makefile`: Automates common tasks like initial setup, configuration, and channel updates.
*   `prepare-system.sh`: A script to prepare the disk with LUKS and Btrfs before initial installation.
*   `channels/`:
    *   `channels.scm`: Defines all desired Guix channels, including `guix`, `nonguix`, `selected-guix-works`, and `abbe`.
    *   `channels-lock.scm`: Stores pinned Guix channel revisions for reproducible builds (generated by `make channel-update`).
*   `config/`:
    *   `home-services/`: Custom Guile Scheme modules defining home services.
        *   `games.scm`: Consolidates Steam package installation and system-level Steam controller udev rules.
        *   `video.scm`: Provides `ffmpeg` and `v4l-utils` via a home service.
        *   `emacs.scm`: Provides a comprehensive Emacs setup via a home service.
        *   `finance.scm`: Provides `hledger` and `emacs-ledger-mode` via a home service.
    *   `packages/`: Custom package definitions or overlays.
        *   `emacs.scm`: Defines custom Emacs packages used by `home-services/emacs.scm`.
    *   `systems/`: System-specific configurations.
        *   `ser8/`:
            *   `configuration.scm`: Main Guix System config for `ser8`, including LUKS, Btrfs, KDE Plasma, PipeWire, `orka` user, and integrated Steam system support.
    *   `users/`: User-specific configurations.
        *   `orka/`:
            *   `home.scm`: Main Guix Home config for `orka`, inheriting common settings, integrating various home services (Emacs, Steam, Video, Finance), and managing dotfiles.
            *   `manifest.scm`: Defines additional user-specific packages (e.g., Google Chrome, VSCode, mpv).
            *   `files/`: Directory for `orka`'s managed dotfiles, applied recursively to `~/`.
    *   `home/`:
        *   `common.scm`: Common Guix Home settings, inherited by user configurations (e.g., Zsh as default shell, Fcitx5 IME, Helix and Neovim editors, common fonts like JetBrains Mono Nerd Font and D2Coding Nerd Font).

## Usage

To use these configurations for a **fresh installation** on a new drive, follow these steps:

1.  **Ensure Guix is Installed**: Make sure you have GNU Guix installed on your system (e.g., on a live USB).

2.  **Clone this Repository**:
    ```bash
    git clone YOUR_REPOSITORY_URL_HERE guix_system
    cd guix_system
    ```

3.  **Prepare the Disk (LUKS & Btrfs)**:
    *   Enter a Guix shell with the necessary tools:
        ```bash
        guix shell parted cryptsetup btrfs-progs make git --
        ```
    *   Run the preparation script. **WARNING: This will erase all data on the selected disk.**
        ```bash
        sudo ./prepare-system.sh
        ```
    *   **Crucially, copy the LUKS and Btrfs filesystem UUIDs printed by the script.** You will need these for the next step.

4.  **Generate User Password Hash**:
    *   In your terminal, generate a password hash for the `orka` user (replace `"YOUR_PASSWORD_HERE"` with your desired password):
        ```bash
        guile -c '(display (crypt "YOURPASSWORD" "$6$randomsalt")) (newline)'
        ```
    *   **Copy the full password hash output.**

5.  **Customize `configuration.scm`**:
    *   Edit `config/systems/ser8/configuration.scm`.
    *   Replace `YOUR_LUKS_PARTITION_UUID_HERE` with the LUKS UUID from step 3.
    *   Replace `YOUR_EFI_PARTITION_UUID_HERE` with the UUID of your EFI partition (e.g., from `sudo blkid /dev/sda1` to confirm).
    *   Replace `YOUR_PASSWORD_HASH_HERE` with the hash you generated in step 4.

6.  **Initial System Installation**:
    *   With the disk prepared and `configuration.scm` updated, perform the initial installation:
        ```bash
        herd start cow-store /mnt
        export TMPDIR=/mnt/data/raynet-guix/tmp
        mkdir -p $TMPDIR
        sudo make install-system
        ```

7.  **Reboot**: After a successful installation, reboot your system into the new Guix installation.

8.  **Apply Home Configuration and Install User-Specific Packages (Optional)**:
    *   Once logged into your new system as `orka`, you can apply your home environment changes (including installing packages and managing dotfiles):
        ```bash
        make all
        # Or more specifically:
        # make reconfigure-home
        # make install-orka-packages
        ```
    *   **Important:** Any changes to `config/users/orka/files` (your managed dotfiles) or other home environment configurations will only take effect after running `make reconfigure-home`.

## Makefile Commands

*   `make init`: Performs `guix pull` and `channel-update`. Recommended to run first on a fresh clone.
*   `make install-system`: (For initial installation only) Performs `guix pull`, `channel-update`, then installs the system from `config/systems/ser8/configuration.scm` to `/mnt`.
*   `make all`: (For an already installed system) Runs `make reconfigure-system` and then `make reconfigure-home`. Use this for general system and home environment updates.
*   `make reconfigure-system`: (For an already installed system) Reconfigures the Guix System using `config/systems/ser8/configuration.scm`.
*   `make reconfigure-home`: (For an already installed system) Reconfigures the Guix Home for `orka` using `config/users/orka/home.scm`, applying package and dotfile changes.
*   `make install-orka-packages`: Installs packages listed in `config/users/orka/manifest.scm` into a dedicated user profile (`~/.guix-profiles/orka-extra`).
*   `make channel-update`: Updates `channels/channels-lock.scm` with currently pinned channels.
*   `make guix-pull`: Performs `guix pull` using the channel definitions in `channels/channels.scm`.
*   `make clean`: Removes `channels/channels-lock.scm`.
